<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Bookings - TransitGo</title>
<link rel="icon" href="./images/logo.png">

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  body { margin:0; font-family:'Poppins',sans-serif; background:linear-gradient(135deg,#232526,#414345); color:white; display:flex; flex-direction:column; align-items:center; padding:30px; }
  h2 { color:#00c6ff; margin-bottom:20px; }
  .booking { background: rgba(255,255,255,0.1); padding:20px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.4); margin-bottom:30px; width:500px; text-align:left; position:relative; }
  .booking h3 { color:#ffd700; margin-top:0; }
  .booking p { margin:6px 0; }
  .btn { background:#00c6ff; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; margin-right:10px; transition:0.3s; }
  .btn:hover { background:#0072ff; }
  .btn.cancel { background:#ff4d4d; }
  .btn.cancel:hover { background:#cc0000; }
  .safe-para { margin-top:10px; font-style:italic; color:#a8ff60; }
  .link { margin-top:15px; }
  .link a { color:#00c6ff; text-decoration:none; }
  .link a:hover { text-decoration:underline; }
  .map { height:250px; width:100%; margin-top:10px; border-radius:10px; }
  .bus-icon { font-size:30px; text-shadow:0 0 5px black; }
  .leaflet-marker-icon.bus-icon { background:transparent; border:none; }
  .message-box { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background: rgba(0,0,0,0.8); padding:20px; border-radius:10px; z-index:1000; text-align:center; display:none; }
  .message-box p { margin:0; font-size:1.2rem; }
  .message-box button { margin-top:10px; background:#00c6ff; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; }
</style>
</head>
<body>

<h2>My Bookings</h2>
<div id="bookingsContainer"></div>

<!-- Message Box -->
<div id="messageBox" class="message-box">
  <p id="messageText"></p>
  <button onclick="hideMessage()">OK</button>
</div>

<div class="link">
  <a href="user-dashboard.html">‚¨Ö Back to Dashboard</a>
</div>

<script>
const cityCoords = {
  "Chittoor":[13.2185,79.1009],"Chennai":[13.0827,80.2707],"Vellore":[12.9165,79.1325],"Tirupathur":[12.4939,78.5583],
  "Haryana":[28.4595,77.0266],"Punjab":[30.7333,76.7794],"Uttar Pradesh":[26.8467,80.9462],"Himachal Pradesh":[31.1048,77.1734],
  "Gujarat":[23.0225,72.5714],"Madhya Pradesh":[23.2599,77.4122],"Chandigarh":[30.7333,76.7794]
};

const busData = [
  { route:"Chittoor ‚Üí Chennai", busNumber:144, driverName:"Driver-1" },
  { route:"Chittoor ‚Üí Vellore", busNumber:102, driverName:"Driver-2" },
  { route:"Chittoor ‚Üí Tirupathur", busNumber:202, driverName:"Driver-3" },
  { route:"Chittoor ‚Üí Chandigarh", busNumber:301, driverName:"Driver-4" },
  { route:"Chittoor ‚Üí Chandigarh", busNumber:302, driverName:"Driver-5" },
  { route:"Chittoor ‚Üí Madhya Pradesh", busNumber:303, driverName:"Driver-6" },
  { route:"Chittoor ‚Üí Punjab", busNumber:304, driverName:"Driver-7" },
  { route:"Chittoort ‚Üí Uttar Pradesh", busNumber:305, driverName:"Driver-8" },
  { route:"Chittoor ‚Üí Gujarat", busNumber:306, driverName:"Driver-9" }
];

function showMessage(text){
  document.getElementById('messageText').innerText=text;
  document.getElementById('messageBox').style.display='block';
}
function hideMessage(){
  document.getElementById('messageBox').style.display='none';
}

function loadBookings(){
  const user = JSON.parse(localStorage.getItem("currentUser"));
  const bookingsContainer = document.getElementById("bookingsContainer");
  bookingsContainer.innerHTML="";
  let allBookings = JSON.parse(localStorage.getItem("allBookings"))||[];
  const userBookings = allBookings.filter(b=>user && b.email===user.email);

  if(userBookings.length===0){
    bookingsContainer.innerHTML="<p>No Bookings Found</p>";
    return;
  }

  userBookings.forEach((booking,index)=>{
    const routeKey = booking.from + " ‚Üí " + booking.to;
    const reverseKey = booking.to + " ‚Üí " + booking.from;

    // ‚úÖ FIX: check both directions
    const busInfo = busData.find(b=>b.route === routeKey || b.route === reverseKey);

    if(!busInfo){
      const div = document.createElement("div");
      div.classList.add("booking");
      div.innerHTML = `
        <h3>Ticket ID: ${booking.id}</h3>
        <p><b>From:</b> ${booking.from}</p>
        <p><b>To:</b> ${booking.to}</p>
        <p style="color:#ff4d4d;"><b>‚ùå Invalid Route</b> - This route is currently not served.</p>
        <button class="btn cancel" onclick="cancelBooking('${booking.id}')">Cancel Ticket</button>
      `;
      bookingsContainer.appendChild(div);
      return;
    }

    // Save trip data
    let trips = JSON.parse(localStorage.getItem("allTrips"))||[];
    if(!trips.find(t=>t.bookingId===booking.id)){
      trips.push({bookingId:booking.id, route:routeKey, busNumber:busInfo.busNumber, driverName:busInfo.driverName, busType:"AC", status:"active"});
      localStorage.setItem("allTrips",JSON.stringify(trips));
    }

    const div = document.createElement("div");
    div.classList.add("booking");
    div.innerHTML=`
      <h3>Ticket ID: ${booking.id}</h3>
      <p><b>From:</b> ${booking.from}</p>
      <p><b>To:</b> ${booking.to}</p>
      <p><b>Date:</b> ${booking.date}</p>
      <p><b>Time:</b> ${booking.time||"Not Provided"}</p>
      <p><b>Seats:</b> ${booking.seats}</p>
      <p><b>Price:</b> ‚Çπ${booking.price}</p>
      <p><b>Booked At:</b> ${booking.bookedAt}</p>
      <div id="map${index}" class="map"></div>
      <p class="safe-para">‚ú® Have a safe journey! ‚ú®</p>
      <button class="btn" onclick="downloadPDF('${booking.id}')">Download PDF</button>
      <button class="btn cancel" onclick="cancelBooking('${booking.id}')">Cancel Ticket</button>
    `;
    bookingsContainer.appendChild(div);

    if(cityCoords[booking.from] && cityCoords[booking.to]){
      initMap(`map${index}`,cityCoords[booking.from],cityCoords[booking.to],booking.id);
    }
  });
}

function cancelBooking(id){
  let allBookings = JSON.parse(localStorage.getItem("allBookings"))||[];
  allBookings = allBookings.filter(b=>b.id!==id);
  localStorage.setItem("allBookings",JSON.stringify(allBookings));

  let trips = JSON.parse(localStorage.getItem("allTrips"))||[];
  trips = trips.filter(t=>t.bookingId!==id);
  localStorage.setItem("allTrips",JSON.stringify(trips));

  showMessage("‚ùå Ticket cancelled successfully!");
  loadBookings();
}

async function downloadPDF(id){
  const { jsPDF } = window.jspdf;
  let allBookings = JSON.parse(localStorage.getItem("allBookings"))||[];
  const booking = allBookings.find(b=>b.id===id);
  if(!booking){showMessage("Ticket not found!");return;}

  const doc = new jsPDF();
  doc.setFont("helvetica","normal");
  let img = new Image();
  img.src="./images/logo.png";
  img.onload=function(){
    doc.addImage(img,"PNG",160,10,30,30);
    doc.setFontSize(18); doc.setTextColor(0,102,204);
    doc.text("TransitGo - Ticket",20,20);
    doc.autoTable({
      startY:50,
      head:[["Field","Details"]],
      body:[
        ["Ticket ID",booking.id],
        ["From",booking.from],
        ["To",booking.to],
        ["Date",booking.date],
        ["Time",booking.time||"Not Provided"],
        ["Seats",booking.seats],
        ["Price",`‚Çπ${booking.price}`],
        ["Booked At",booking.bookedAt]
      ],
      theme:"grid",
      styles:{font:"helvetica",fontSize:12,halign:"center"},
      headStyles:{fillColor:[0,102,204],textColor:255},
      alternateRowStyles:{fillColor:[220,230,240]}
    });
    doc.setFontSize(14); doc.setTextColor(0,128,0);
    doc.text("‚ú® Have a safe journey! ‚ú®",65,doc.internal.pageSize.height-20);
    doc.save(`Ticket_${booking.id}.pdf`);
  };
}

function initMap(mapId, fromLatLng, toLatLng, bookingId){
  const map = L.map(mapId).setView(fromLatLng,7);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(map);
  const routeLine = L.polyline([fromLatLng,toLatLng],{color:"blue"}).addTo(map);
  map.fitBounds(routeLine.getBounds());
  setTimeout(()=>map.invalidateSize(),200);

  const busIcon = L.divIcon({html:"üöç",className:"bus-icon",iconSize:[30,30]});
  const busMarker = L.marker(fromLatLng,{icon:busIcon}).addTo(map);

  const steps = 200; 
  const path = [];
  for(let j=0;j<=steps;j++){
    let lat = fromLatLng[0]+(toLatLng[0]-fromLatLng[0])*(j/steps);
    let lng = fromLatLng[1]+(toLatLng[1]-fromLatLng[1])*(j/steps);
    path.push([lat,lng]);
  }

  let i=0;
  function moveBus(){
    if(i<path.length){
      busMarker.setLatLng(path[i]); 
      i++; 
      setTimeout(moveBus,100);
    } else {
      let trips = JSON.parse(localStorage.getItem("allTrips"))||[];
      let tripIndex = trips.findIndex(t=>t.bookingId===bookingId);
      if(tripIndex!==-1){
        trips[tripIndex].status="completed"; 
        localStorage.setItem("allTrips",JSON.stringify(trips));
      }
    }
  }
  moveBus();
}

// Initial load
loadBookings();
</script>
</body>
</html>
