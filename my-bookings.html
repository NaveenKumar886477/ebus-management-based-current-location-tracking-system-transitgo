<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Bookings - TransitGo</title>
<link rel="icon" href="./images/logo.png">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
Â  body { 
    margin:0; 
    font-family:'Poppins',sans-serif; 
    background:linear-gradient(135deg,#232526,#414345); 
    color:white; 
    display:flex; 
    flex-direction:column; 
    align-items:center; 
    padding:30px; 
    min-height: 100vh; /* Ensure full viewport height */
}
Â  h2 { color:#00c6ff; margin-bottom:20px; }
Â  .booking { 
    background: rgba(255,255,255,0.1); 
    padding:20px; 
    border-radius:12px; 
    box-shadow:0 6px 20px rgba(0,0,0,0.4); 
    margin-bottom:30px; 
    width:500px; /* Default width for desktop/tablet */
    max-width: 100%; /* Ensure it respects parent width */
    text-align:left; 
    position:relative; 
}
Â  .booking h3 { color:#ffd700; margin-top:0; font-size: 1.5rem; }
Â  .booking p { margin:6px 0; font-size: 1rem; }
Â  .btn { 
    background:#00c6ff; 
    color:white; 
    border:none; 
    padding:8px 15px; 
    border-radius:8px; 
    cursor:pointer; 
    margin-right:10px; 
    transition:0.3s; 
    font-size: 0.95rem;
}
Â  .btn:hover { background:#0072ff; }
Â  .btn.cancel { background:#ff4d4d; }
Â  .btn.cancel:hover { background:#cc0000; }
Â  .safe-para { margin-top:10px; font-style:italic; color:#a8ff60; }
Â  .link { margin-top:15px; }
Â  .link a { color:#00c6ff; text-decoration:none; transition: 0.3s; }
Â  .link a:hover { text-decoration:underline; color: #4dc2ff; }
Â  .map { height:250px; width:100%; margin-top:10px; border-radius:10px; }
Â  .bus-icon { font-size:30px; text-shadow:0 0 5px black; }
Â  .leaflet-marker-icon.bus-icon { background:transparent; border:none; }
Â  .message-box { 
    position:fixed; 
    top:50%; 
    left:50%; 
    transform:translate(-50%,-50%); 
    background: rgba(0,0,0,0.8); 
    padding:20px; 
    border-radius:10px; 
    z-index:1000; 
    text-align:center; 
    display:none; 
    max-width: 80%; /* Ensure it fits on smaller screens */
}
Â  .message-box p { margin:0; font-size:1.2rem; }
Â  .message-box button { margin-top:10px; background:#00c6ff; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; }
Â  
/* =================================
Â  Â  Â  MEDIA QUERIES FOR RESPONSIVENESS
Â  Â  ================================= */

/* 1. Medium Devices (Tablets, Max width 768px) */
@media (max-width: 768px) {
    body {
        padding: 20px;
    }
    .booking { 
        /* Allow booking card to take more width on tablets */
        width: 85%;
        padding: 18px;
    }
    .map {
        height: 200px; /* Slightly reduce map height */
    }
}

/* 2. Small Devices (Mobile Phones, Max width 576px) */
@media (max-width: 576px) {
    body {
        padding: 15px 10px; /* Reduced padding for smaller screens */
        align-items: stretch; /* Stretch content to edges */
    }
    h2 {
        font-size: 1.8rem;
        margin-bottom: 15px;
        text-align: center;
    }
    .booking {
        /* Full width of the container (minus body padding) */
        width: 100%;
        padding: 15px;
        margin-bottom: 20px;
        box-sizing: border-box; /* Include padding in the width calculation */
    }
    .booking h3 {
        font-size: 1.3rem;
        margin-bottom: 10px;
    }
    .booking p {
        font-size: 0.95rem;
    }
    .btn {
        /* Make buttons stack nicely on mobile */
        display: block;
        width: 100%;
        margin: 10px 0 0 0; /* Full width and space them out */
        padding: 10px;
        box-sizing: border-box;
    }
    .btn:first-of-type {
        margin-top: 15px; /* Add space above the first button */
    }
    .map {
        height: 180px; /* Further reduce map height for minimal vertical scroll */
    }
    .message-box {
        padding: 15px;
    }
    .message-box p {
        font-size: 1rem;
    }
}

/* 3. Extra Small Devices (Max width 350px) */
@media (max-width: 350px) {
    h2 {
        font-size: 1.5rem;
    }
    .booking h3 {
        font-size: 1.1rem;
    }
    .booking p {
        font-size: 0.9rem;
    }
}
</style>
</head>
<body>

<h2>My Bookings</h2>
<div id="bookingsContainer"></div>

<div id="messageBox" class="message-box">
Â  <p id="messageText"></p>
Â  <button onclick="hideMessage()">OK</button>
</div>

<div class="link">
Â  <a href="user-dashboard.html">â¬… Back to Dashboard</a>
</div>

<script>
const cityCoords = {
Â  "Chittoor":[13.2185,79.1009],"Chennai":[13.0827,80.2707],"Vellore":[12.9165,79.1325],"Tirupathur":[12.4939,78.5583],
Â  "Haryana":[28.4595,77.0266],"Punjab":[30.7333,76.7794],"Uttar Pradesh":[26.8467,80.9462],"Himachal Pradesh":[31.1048,77.1734],
Â  "Gujarat":[23.0225,72.5714],"Madhya Pradesh":[23.2599,77.4122],"Chandigarh":[30.7333,76.7794]
};

const busData = [
Â  { route:"Chittoor â†’ Chennai", busNumber:144, driverName:"Driver-1" },
Â  { route:"Chittoor â†’ Vellore", busNumber:102, driverName:"Driver-2" },
Â  { route:"Chittoor â†’ Tirupathur", busNumber:202, driverName:"Driver-3" },
Â  { route:"Haryana â†’ Chandigarh", busNumber:301, driverName:"Driver-4" },
Â  { route:"Punjab â†’ Chandigarh", busNumber:302, driverName:"Driver-5" },
Â  { route:"Uttar Pradesh â†’ Madhya Pradesh", busNumber:303, driverName:"Driver-6" },
Â  { route:"Himachal Pradesh â†’ Punjab", busNumber:304, driverName:"Driver-7" },
Â  { route:"Gujarat â†’ Uttar Pradesh", busNumber:305, driverName:"Driver-8" },
Â  { route:"Madhya Pradesh â†’ Gujarat", busNumber:306, driverName:"Driver-9" }
];

function showMessage(text){document.getElementById('messageText').innerText=text;document.getElementById('messageBox').style.display='block';}
function hideMessage(){document.getElementById('messageBox').style.display='none';}

function loadBookings(){
Â  const user = JSON.parse(localStorage.getItem("currentUser"));
Â  const bookingsContainer = document.getElementById("bookingsContainer");
Â  bookingsContainer.innerHTML="";
Â  let allBookings = JSON.parse(localStorage.getItem("allBookings"))||[];
Â  const userBookings = allBookings.filter(b=>user&&b.email===user.email);

Â  if(userBookings.length===0){bookingsContainer.innerHTML="<p>No Bookings Found</p>"; return;}

Â  userBookings.forEach((booking,index)=>{
Â  Â  const routeKey = booking.from + " â†’ " + booking.to;
Â  Â  const busInfo = busData.find(b=>b.route===routeKey);

Â  Â  if(!busInfo){
Â  Â  Â  // Only show invalid route message and skip further processing
Â  Â  Â  const div = document.createElement("div");
Â  Â  Â  div.classList.add("booking");
Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  <h3>Ticket ID: ${booking.id}</h3>
Â  Â  Â  Â  <p><b>From:</b> ${booking.from}</p>
Â  Â  Â  Â  <p><b>To:</b> ${booking.to}</p>
Â  Â  Â  Â  <p style="color:#ff4d4d;"><b>âŒ Invalid Route</b> - This route is currently not served.</p>
Â  Â  Â  Â  <button class="btn cancel" onclick="cancelBooking('${booking.id}')">Cancel Ticket</button>
Â  Â  Â  `;
Â  Â  Â  bookingsContainer.appendChild(div);
Â  Â  Â  return; // Skip map and animation
Â  Â  }

Â  Â  // Add trip to allTrips if not already added
Â  Â  let trips = JSON.parse(localStorage.getItem("allTrips"))||[];
Â  Â  if(!trips.find(t=>t.bookingId===booking.id)){
Â  Â  Â  trips.push({bookingId:booking.id, route:routeKey, busNumber:busInfo.busNumber, driverName:busInfo.driverName, busType:"AC", status:"active"});
Â  Â  Â  localStorage.setItem("allTrips",JSON.stringify(trips));
Â  Â  }

Â  Â  const div = document.createElement("div");
Â  Â  div.classList.add("booking");
Â  Â  div.innerHTML=`
Â  Â  Â  <h3>Ticket ID: ${booking.id}</h3>
Â  Â  Â  <p><b>From:</b> ${booking.from}</p>
Â  Â  Â  <p><b>To:</b> ${booking.to}</p>
Â  Â  Â  <p><b>Date:</b> ${booking.date}</p>
Â  Â  Â  <p><b>Time:</b> ${booking.time||"Not Provided"}</p>
Â  Â  Â  <p><b>Seats:</b> ${booking.seats}</p>
Â  Â  Â  <p><b>Price:</b> â‚¹${booking.price}</p>
Â  Â  Â  <p><b>Booked At:</b> ${booking.bookedAt}</p>
Â  Â  Â  <div id="map${index}" class="map"></div>
Â  Â  Â  <p class="safe-para">âœ¨ Have a safe journey! âœ¨</p>
Â  Â  Â  <button class="btn" onclick="downloadPDF('${booking.id}')">Download PDF</button>
Â  Â  Â  <button class="btn cancel" onclick="cancelBooking('${booking.id}')">Cancel Ticket</button>
Â  Â  `;
Â  Â  bookingsContainer.appendChild(div);

Â  Â  // Only initialize map if cities exist
Â  Â  if(cityCoords[booking.from]&&cityCoords[booking.to]){
Â  Â  Â  initMap(`map${index}`,cityCoords[booking.from],cityCoords[booking.to],booking.id,booking);
Â  Â  }
Â  });
}

function cancelBooking(id){
Â  let allBookings = JSON.parse(localStorage.getItem("allBookings"))||[];
Â  allBookings = allBookings.filter(b=>b.id!==id);
Â  localStorage.setItem("allBookings",JSON.stringify(allBookings));

Â  let trips = JSON.parse(localStorage.getItem("allTrips"))||[];
Â  trips = trips.filter(t=>t.bookingId!==id);
Â  localStorage.setItem("allTrips",JSON.stringify(trips));

Â  showMessage("âŒ Ticket cancelled successfully!");
Â  loadBookings();
}

// PDF and map functions remain unchanged
async function downloadPDF(id){
Â  const { jsPDF } = window.jspdf;
Â  let allBookings = JSON.parse(localStorage.getItem("allBookings"))||[];
Â  const booking = allBookings.find(b=>b.id===id);
Â  if(!booking){showMessage("Ticket not found!");return;}
Â  const doc = new jsPDF();
Â  doc.setFont("helvetica","normal");
Â  let img = new Image();
Â  img.src="./images/logo.png";
Â  img.onload=function(){
Â  Â  doc.addImage(img,"PNG",160,10,30,30);
Â  Â  doc.setFontSize(18); doc.setTextColor(0,102,204);
Â  Â  doc.text("TransitGo - Ticket",20,20);
Â  Â  doc.autoTable({startY:50,head:[["Field","Details"]],body:[["Ticket ID",booking.id],["From",booking.from],["To",booking.to],["Date",booking.date],["Time",booking.time||"Not Provided"],["Seats",booking.seats],["Price",`â‚¹${booking.price}`],["Booked At",booking.bookedAt]],theme:"grid",styles:{font:"helvetica",fontSize:12,halign:"center"},headStyles:{fillColor:[0,102,204],textColor:255},alternateRowStyles:{fillColor:[220,230,240]}});
Â  Â  doc.setFontSize(14); doc.setTextColor(0,128,0);
Â  Â  doc.text("âœ¨ Have a safe journey! âœ¨",65,doc.internal.pageSize.height-20);
Â  Â  doc.save(`Ticket_${booking.id}.pdf`);
Â  };
}

function initMap(mapId, fromLatLng, toLatLng, bookingId, booking){
Â  const map = L.map(mapId).setView(fromLatLng,7);
Â  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(map);
Â  const routeLine = L.polyline([fromLatLng,toLatLng],{color:"blue"}).addTo(map);
Â  map.fitBounds(routeLine.getBounds());
Â  setTimeout(()=>map.invalidateSize(),200);
Â  const busIcon = L.divIcon({html:"ğŸš",className:"bus-icon",iconSize:[30,30]});
Â  const busMarker = L.marker(fromLatLng,{icon:busIcon}).addTo(map);

Â  const steps = 200;Â 
Â  const path = [];
Â  for(let j=0;j<=steps;j++){
Â  Â  let lat = fromLatLng[0]+(toLatLng[0]-fromLatLng[0])*(j/steps);
Â  Â  let lng = fromLatLng[1]+(toLatLng[1]-fromLatLng[1])*(j/steps);
Â  Â  path.push([lat,lng]);
Â  }

Â  let i=0;
Â  function moveBus(){
Â  Â  if(i<path.length){
Â  Â  Â  busMarker.setLatLng(path[i]);Â 
Â  Â  Â  i++;Â 
Â  Â  Â  setTimeout(moveBus,100);
Â  Â  } else {
Â  Â  Â  // Bus reached destination, no message displayed
Â  Â  Â  let trips = JSON.parse(localStorage.getItem("allTrips"))||[];
Â  Â  Â  let tripIndex = trips.findIndex(t=>t.bookingId===bookingId);
Â  Â  Â  if(tripIndex!==-1){
Â  Â  Â  Â  trips[tripIndex].status="completed";Â 
Â  Â  Â  Â  localStorage.setItem("allTrips",JSON.stringify(trips));
Â  Â  Â  }
Â  Â  }
Â  }
Â  moveBus();
}
loadBookings();

loadBookings();
</script>
</body>
</html>
